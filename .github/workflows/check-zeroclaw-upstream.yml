name: Check ZeroClaw Upstream

on:
  schedule:
    - cron: "15 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: check-zeroclaw-upstream
  cancel-in-progress: false

jobs:
  check:
    name: Check upstream release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compare pinned vs latest release
        id: compare
        shell: bash
        run: |
          set -euo pipefail

          current="$(awk -F= '/^ARG ZEROCLAW_VERSION=/{print $2; exit}' zeroclaw/Dockerfile | tr -d '[:space:]')"
          if [[ -z "${current}" ]]; then
            echo "Could not read ARG ZEROCLAW_VERSION from zeroclaw/Dockerfile" >&2
            exit 1
          fi

          latest="$(curl -fsSL https://api.github.com/repos/zeroclaw-labs/zeroclaw/releases/latest | jq -r '.tag_name')"
          if [[ -z "${latest}" || "${latest}" == "null" ]]; then
            latest="$(curl -fsSL 'https://api.github.com/repos/zeroclaw-labs/zeroclaw/tags?per_page=1' | jq -r '.[0].name')"
          fi

          if [[ -z "${latest}" || "${latest}" == "null" ]]; then
            echo "Could not resolve latest zeroclaw tag/release" >&2
            exit 1
          fi

          update_available="false"
          if [[ "${current}" != "${latest}" ]]; then
            update_available="true"
          fi

          latest_sanitized="$(echo "${latest}" | tr -c '[:alnum:]._-' '-')"

          echo "current=${current}" >> "${GITHUB_OUTPUT}"
          echo "latest=${latest}" >> "${GITHUB_OUTPUT}"
          echo "latest_sanitized=${latest_sanitized}" >> "${GITHUB_OUTPUT}"
          echo "update_available=${update_available}" >> "${GITHUB_OUTPUT}"

          {
            echo "## ZeroClaw Upstream Check"
            echo ""
            echo "- Pinned in add-on: \`${current}\`"
            echo "- Latest upstream: \`${latest}\`"
            echo "- Update available: \`${update_available}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Update pinned versions
        id: bump
        if: steps.compare.outputs.update_available == 'true'
        shell: bash
        env:
          LATEST: ${{ steps.compare.outputs.latest }}
        run: |
          set -euo pipefail

          current_addon_version="$(awk -F': ' '/^version:/{gsub(/"/,"",$2); print $2; exit}' zeroclaw/config.yaml)"
          if [[ -z "${current_addon_version}" ]]; then
            echo "Could not read add-on version from zeroclaw/config.yaml" >&2
            exit 1
          fi

          if [[ "${current_addon_version}" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)$ ]]; then
            base="${BASH_REMATCH[1]}"
            n="${BASH_REMATCH[2]}"
            next_addon_version="${base}-$((n + 1))"
          elif [[ "${current_addon_version}" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            next_addon_version="${current_addon_version}-1"
          else
            echo "Unsupported add-on version format: ${current_addon_version}" >&2
            exit 1
          fi

          sed -E -i "s/^ARG ZEROCLAW_VERSION=.*/ARG ZEROCLAW_VERSION=${LATEST}/" zeroclaw/Dockerfile
          sed -E -i "s/^version: .*/version: ${next_addon_version}/" zeroclaw/config.yaml

          echo "next_addon_version=${next_addon_version}" >> "${GITHUB_OUTPUT}"

      - name: Create pull request when update is available
        if: steps.compare.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: bump zeroclaw to ${{ steps.compare.outputs.latest }}"
          branch: "chore/bump-zeroclaw-${{ steps.compare.outputs.latest_sanitized }}"
          delete-branch: true
          title: "chore: bump zeroclaw to ${{ steps.compare.outputs.latest }}"
          body: |
            Automatisches Update der gepinnten ZeroClaw-Version.

            - Alt: `${{ steps.compare.outputs.current }}`
            - Neu: `${{ steps.compare.outputs.latest }}`
            - Neue Add-on-Version: `${{ steps.bump.outputs.next_addon_version }}`

            Ã„nderungen:
            - `zeroclaw/Dockerfile`: `ARG ZEROCLAW_VERSION`
            - `zeroclaw/config.yaml`: `version`
